<?php/* * Copyright (c) 2023. * RW::Software * Dave Conley * https://www.rwscripts.com/ */class stats{	var $html;	function stats()	{		global $OUTPUT;		$this->html = $OUTPUT->load_template("skin_stats");	}	function topDownloads($limit = "0,5")	{		global $DB, $std, $guser, $module;		$result = $DB->query("SELECT l.*, sym.*                    FROM dl_symlinks sym                    LEFT JOIN dl_links l ON (l.did=sym.sym_did)                    WHERE l.approved=1                    ORDER BY `downloads` DESC LIMIT $limit");		$output = "";		if ($myrow = $DB->fetch_row($result)) {			do {				if (!$std->canAccess($myrow["sym_catid"], "canBrowse"))					continue;				$output .= $module->html_skincall("topdownloads", $this->html, $myrow);			} while ($myrow = $DB->fetch_row($result));		}		return $output;	}	function topRatedDownloads($limit = "0,5")	{		global $DB, $std, $guser, $module;		$result = $DB->query("SELECT l.*, sym.*                    FROM dl_symlinks sym                    LEFT JOIN dl_links l ON (l.did=sym.sym_did)                    WHERE l.approved=1 and l.votes > 5                    ORDER BY `userrating` DESC LIMIT $limit");		$output = "";		if ($myrow = $DB->fetch_row($result)) {			do {				if (!$std->canAccess($myrow["sym_catid"], "canBrowse"))					continue;				$output .= $module->html_skincall("topRatedDownloads", $this->html, $myrow);			} while ($myrow = $DB->fetch_row($result));		}		return $output;	}	function latestDownloads($limit = "0,5")	{		global $DB, $std, $guser, $module;		$result = $DB->query("SELECT l.*, sym.*                    FROM dl_symlinks sym                    LEFT JOIN dl_links l ON (l.did=sym.sym_did)                    WHERE l.approved=1                    ORDER BY `date` DESC LIMIT $limit");		$output = "";		if ($myrow = $DB->fetch_row($result)) {			do {				if (!$std->canAccess($myrow["sym_catid"], "canBrowse") || $previousfile == $myrow["sym_did"])					continue;				$output .= $module->html_skincall("latestDownloads", $this->html, $myrow);				$previousfile = $myrow["sym_did"];			} while ($myrow = $DB->fetch_row($result));		}		return $output;	}	function totalDownloads()	{		global $DB, $std, $module;		$result = $DB->query("SELECT did, realsize, downloads FROM dl_links WHERE approved = 1");		$rows = $DB->num_rows($result);		$totalsize = 0;		$downloads = 0;		while ($myrow = $DB->fetch_row($result)) {			$totalsize += $myrow['realsize'];			$downloads += $myrow['downloads'];		}		$data = array("total" => $rows,			"downloads" => $downloads,			"size" => $std->my_filesize($totalsize));		return $module->html_skincall("totalDownloads", $this->html, $data);	}	function showRandomDownload($catid = 0, $pinnedOnly = 0)	{		global $DB, $std, $module;		if ($catid) {			if (!$std->canAccess($catid))				return;			$wherecat = " AND sl.sym_catid='{$catid}'";		}		if ($pinnedOnly) {			$wherepinned = " AND l.pinned='checked'";		}		$result = $DB->query("SELECT * FROM `dl_links` l                             LEFT JOIN `dl_symlinks` sl ON (sl.sym_did=l.did)                             WHERE l.approved='1' $wherecat $wherepinned ORDER BY RAND()");		while ($myrow = $DB->fetch_row($result)) {			if (!$std->canAccess($myrow["sym_catid"], "canBrowse"))				continue;			else {				$data = array();				require_once(ROOT_PATH . "/functions/files.php");				$files = new files();				$data = $files->parse_file_data($myrow, array(), 0, 0, 0, false);				$data = $std->my_stripslashes($data);				if ($std->isUsingFullVersion()) {					$data["adminrating"] = GETLANG("cap_adRate") . ": " . $data["adminrating"];					$data["userrating"] = GETLANG("cap_userRate") . ": " . $data["userrating"];				}				return $module->html_skincall("randomDownload", $this->html, $data);			}		}		return "FISH!";	}}?>