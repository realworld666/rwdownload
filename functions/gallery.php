<?php/* * Copyright (c) 2023. * RW::Software * Dave Conley * https://www.rwscripts.com/ */class gallery{	var $html;	function gallery()	{		global $rwdInfo, $OUTPUT, $IN, $DB;		$this->html = $OUTPUT->load_template("skin_gallery");		switch ($IN['ACT']) {			case "browser":				$this->view_browser_image();				break;		}	}	function view_browser_image()	{		global $std, $CONFIG, $OUTPUT, $IN, $DB, $module;		$output = "";		$DB->query("SELECT * FROM dl_images WHERE `id`='{$IN['id']}'");		$myrow = $DB->fetch_row();		$DB->query("SELECT * FROM dl_images WHERE `dlid`='{$myrow['dlid']}'");		$lastid = 0;		$nextid = 0;		$found = false;		while ($all = $DB->fetch_row()) {			if ($found) {				$nextid = $all['id'];				break;			}			if ($all['id'] == $myrow['id']) {				$found = true;			}			if (!$found) {				$lastid = $all['id'];			}		}		$size = explode("x", $myrow['size']);		$data = array("imageurl" => $CONFIG['imagesurl'] . "/{$myrow['realName']}",			"maxWidth" => min($CONFIG['maxBrowserWidth'], $size[0]),			"maxHeight" => min($CONFIG['maxHeight'], $size[1]));		if ($lastid)			$data['previous'] = "<a href='index.php?ACT=browser&amp;id={$lastid}'>" . GETLANG("previous") . "</a>";		if ($nextid)			$data['next'] = "<a href='index.php?ACT=browser&amp;id={$nextid}'>" . GETLANG("next") . "</a>";		$output = $module->html_skincall("browser_view", $this->html, $data);		$OUTPUT->add_output($output);	}	// Removes all thumbnails from download	function remove_thumbs($id = 0)	{		global $DB, $CONFIG, $rwdInfo;		if ($id == 0)			return;		$result = $DB->query("SELECT * FROM dl_images WHERE dlid=$id");		if ($rows = $DB->fetch_row($result)) {			do {				$file = $CONFIG['imagesfolder'] . "/" . $rows["realName"];				if (is_file($file))					unlink($file);				$file = $CONFIG['imagesfolder'] . "/t_" . $rows["realName"];				if (is_file($file))					unlink($file);			} while ($rows = $DB->fetch_row($result));		}	}	function removeThumb($thispage, $return)	{		global $DB, $IN, $CONFIG, $rwdInfo, $sid, $std, $act;		if ($IN["confirm"]) {			$result = $DB->query("SELECT * FROM dl_images WHERE id=$IN[imgid]");			$rows = $DB->fetch_row($result);			if (is_file($CONFIG['imagesfolder'] . "/" . $rows["realName"]))				unlink($CONFIG['imagesfolder'] . "/" . $rows["realName"]);			if (is_file($CONFIG['imagesfolder'] . "/t_" . $rows["realName"]))				unlink($CONFIG['imagesfolder'] . "/t_" . $rows["realName"]);			$result = $DB->query("DELETE FROM dl_images WHERE id=$IN[imgid]");			$std->info(GETLANG("deldl") . "<p>" . "<a href='$return'>" . GETLANG("continue") . "</a>");		} else if ($IN["cancel"]) {			$std->info(GETLANG("delcancel") . "<p>" . "<a href='$return'>" . GETLANG("continue") . "</a>");		} else {			$std->warning(GETLANG("warn_imgdel") . "<p>"				. "<form method='post' action='" . $thispage . "'>"				. "<input type='hidden' name='imgid' value='" . $_GET["imgid"] . "'>"				. "<input type='Submit' name='confirm' value='" . GETLANG("yes") . "'>"				. "<input type='Submit' name='cancel' value='" . GETLANG("no") . "'> </form>");		}	}	function thumbTable($dlid, $symid, $owner, $admin = 0)	{		global $DB, $IN, $CONFIG, $rwdInfo, $guser, $sid, $module;		if (!$CONFIG["display_thumbs"])			return "";		$DB->query("SELECT * FROM `dl_images` WHERE `dlid`='{$dlid}' ORDER BY id");		if ($imgVal = $DB->fetch_row()) {			$firsttime = true;			$array = array("gallWidth" => $CONFIG["maxBrowserWidth"],				"gallHeight" => $CONFIG["maxBrowserHeight"]);			$data = $module->html_skincall("thumb_table_head", $this->html, $array);			$count = 0;			$rows = 0;			do {				// Roughly Calculate thumbnail dimensions in case a thumbnail doesnt exist				$size = explode("x", $imgVal["size"]);				$width = $size[0];				$height = $size[1];				if ($width > $height) {					if ($width > $CONFIG["thumbWidth"])						$dims = "width=$CONFIG[thumbWidth]";					else						$dims = "width=$width";				} else {					if ($height > $CONFIG["thumbHeight"])						$dims = "height=$CONFIG[thumbHeight]";					else						$dims = "height=$height";				}				// If we have done all the thumbs allowed for this row then start a new one				if ($count >= $CONFIG["num_gall_cols"]) {					$count = 0;					$data .= $module->html_skincall("thumb_end_row", $this->html);					$rows++;				}				$imgid = $imgVal["id"];				$thisthumb = array();				// Add the delete image link if required				$values = array();				if ($admin) {					if ($guser->isAdmin)						$values['editlink'] = "?sid=$sid&area=files&act=deleteimg&imgid=$imgid&id=$symid";				} else if ($owner == $guser->userid || $guser->isAdmin)					$values['editlink'] = "?ACT=deleteimg&imgid=$imgid&did=$dlid&symid=$symid";				if ($values['editlink'])					$editrow = $module->html_skincall("thumb_editrow", $this->html, $values);				$thisthumb['editrow'] = $editrow;				// Main thumb data				$thisthumb['imageurl'] = "index.php?ACT=browser&id={$imgid}";				// If thumbnail exists then use that otherwise show a resized version of the full image				if (is_file($CONFIG['imagesfolder'] . "/t_" . $imgVal["realName"]))					$thisthumb['thumburl'] = $CONFIG['imagesurl'] . "/t_{$imgVal['realName']}";				else {					$thisthumb['thumburl'] = $CONFIG['imagesurl'] . "/{$imgVal['realName']}";					$thisthumb['dims'] = $dims;				}				$thisthumb['cellwidth'] = "##WIDTH##";				$data .= $module->html_skincall("thumb_cell", $this->html, $thisthumb);				$count++;			} while ($imgVal = $DB->fetch_row());			$width == 0;			if ($rows == 0) {				$width = intval(100 / $count);				$width .= "%";			} else {				$width = intval(100 / $CONFIG["num_gall_cols"]);				$width .= "%";				while ($count++ < $CONFIG["num_gall_cols"]) {					$thisthumb = array();					$thisthumb['cellwidth'] = "##WIDTH##";					$data .= $module->html_skincall("thumb_empty", $this->html, $thisthumb);				}			}			$data = str_replace("##WIDTH##", $width, $data);			$data .= $module->html_skincall("thumb_table_foot", $this->html);		}		return $data;	}	function getFirstThumb($myrow = array())	{		// Recieves an array - usually a left joined download with image data in it		// Get out the information we need and return		global $DB, $IN, $CONFIG, $rwdInfo, $guser, $sid, $module;		if (!$CONFIG["display_thumbs"])			return "";		$firsttime = true;		if ($myrow['realName']) {			// Roughly Calculate thumbnail dimensions in case a thumbnail doesnt exist			$size = explode("x", $myrow["size"]);			$width = $size[0];			$height = $size[1];			if ($width > $height) {				if ($width > $CONFIG["thumbWidth"])					$dims = "width=$CONFIG[thumbWidth]";				else					$dims = "width=$width";			} else {				if ($height > $CONFIG["thumbHeight"])					$dims = "height=$CONFIG[thumbHeight]";				else					$dims = "height=$height";			}			$imgid = $myrow["id"];			$thisthumb = array();			// Main thumb data			$thisthumb['imageurl'] = $CONFIG['imagesurl'] . "/{$myrow['realName']}";			// If thumbnail exists then use that otherwise show a resized version of the full image			if (is_file($CONFIG['imagesfolder'] . "/t_" . $imgVal["realName"]))				$thisthumb['thumburl'] = $CONFIG['imagesurl'] . "/t_{$imgVal['realName']}";			else {				$thisthumb['thumburl'] = $CONFIG['imagesurl'] . "/{$myrow['realName']}";				$thisthumb['dims'] = $dims;			}			$thisthumb['cellwidth'] = "##WIDTH##";			$data = $module->html_skincall("thumb_plain", $this->html, $thisthumb);		}		return $data;	}}$loader = new gallery();?>