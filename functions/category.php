<?php/* * Copyright (c) 2023. * RW::Software * Dave Conley * https://www.rwscripts.com/ */class Category{	var $html = "";	var $output = "";	function Category()	{		global $rwdInfo, $OUTPUT, $DB;		if (!$rwdInfo->cats_saved) {			$DB->query("SELECT * FROM dl_categories ORDER BY parentid ASC, sortorder ASC");			if ($myrow = $DB->fetch_row()) {				do {					// Add category to cache					$rwdInfo->cat_cache[$myrow["cid"]] = $myrow;				} while ($myrow = $DB->fetch_row());			}			$rwdInfo->cats_saved = 1;		}		$this->html = $OUTPUT->load_template("skin_category");	}	function getLatestFileInfo($categoryData)	{		global $rwdInfo, $std;		foreach ($rwdInfo->cat_cache as $subcat) {			if ($subcat['parentid'] == $categoryData['cid']) {				$tempData = $this->getLatestFileInfo($subcat);    // Recurse until at the end of the tree				//$categoryData['downloads'] += $subcat['downloads'];				$categoryData['downloads'] += $tempData['downloads'];				if ($tempData['lastDate'] > $categoryData['lastDate']) {					$categoryData['lastDate'] = $tempData['lastDate'];					$categoryData['lastid'] = $tempData['lastid'];					$categoryData['lastTitle'] = $tempData['lastTitle'];				}			}		}		return $categoryData;	}	function listAll($parent = 0)	{		global $DB, $IN, $CONFIG, $std, $rwdInfo, $module;		// Count the number of categories user can see. If 0 then display a message to the user		$catsShown = -1;		if ($std->isUsingFullVersion()) {			$result = $DB->query("SELECT * FROM dl_categories WHERE parentid=$parent ORDER BY sortorder");		} else {			if ($parent != 0) {				return -1;			}			$result = $DB->query("SELECT * FROM dl_categories ORDER BY sortorder");		}		if ($myrow = $DB->fetch_row($result)) {			// Add category to cache			$rwdInfo->cat_cache[$myrow["cid"]] = $myrow;			// There are categories so make this 0			$catsShown = 0;			$data = array(				"cat_id" => $catData['cid'],				"current_cat" => $parent,				"cat_thumb" => $thumb,				"cat_name" => $cat_name,				"cat_latest" => $cat_latest,				"cat_desc" => $cat_desc,				"cat_dlcount" => $rows,				"cat_subcats" => $subcatlist);			if ($parent != 0)				$this->output .= $module->html_skincall("sub_cat_head", $this->html, $data);			else				$this->output .= $module->html_skincall("cat_head", $this->html, $data);			do {				// If user has no browse permissions then skip this category				if (!$std->canAccess($myrow["cid"], "canBrowse"))					continue;				$catData = $this->getLatestFileInfo($myrow);				$rows = $catData['downloads'];				if ($catData['thumb']) {					if (is_file("{$CONFIG['imagesfolder']}/t_{$catData['thumb']}"))						$thumb = "<a href='index.php?cid={$catData['cid']}'><img src='{$CONFIG['imagesurl']}/t_{$catData['thumb']}' border='0' class='thumb' alt='{$catData['name']}'></a>";					else						$thumb = "<a href='index.php?cid={$catData['cid']}'><img src='{$CONFIG['imagesurl']}/{$catData['thumb']}' border='0' class='thumb' alt='{$catData['name']}'></a>";				} else					$thumb = "";				$cat_name = "<a href='index.php?cid={$catData['cid']}'>{$catData['name']}</a>";				if ($rows > 0)					$cat_latest = "<a href='?dlid={$catData['lastid']}'>{$catData['lastTitle']}</a>";				else					$cat_latest = GETLANG("nodls");				$cat_desc = nl2br($catData['description']);				$subcatlist = "";				if ($std->isUsingFullVersion()) {					foreach ($rwdInfo->cat_cache as $subcat) {						if ($subcat["parentid"] == $catData['cid']) {							if ($subcatlist)								$subcatlist .= " | ";							$subcatlist .= "<a href='index.php?cid={$subcat['cid']}'>{$subcat['name']}</a>";						}					}				}				$data = array(					"cat_id" => $catData['cid'],					"current_cat" => $parent,					"cat_thumb" => $thumb,					"cat_name" => $cat_name,					"cat_latest" => $cat_latest,					"cat_desc" => $cat_desc,					"cat_dlcount" => $rows,					"cat_subcats" => $subcatlist);				if ($parent != 0)					$this->output .= $module->html_skincall("sub_cat_row", $this->html, $data);				else					$this->output .= $module->html_skincall("cat_row", $this->html, $data);				// Increment counter				$catsShown++;			} while ($myrow = $DB->fetch_row($result));			$data = array(				"cat_id" => $catData['cid'],				"current_cat" => $parent,				"cat_thumb" => $thumb,				"cat_name" => $cat_name,				"cat_latest" => $cat_latest,				"cat_desc" => $cat_desc,				"cat_dlcount" => $rows,				"cat_subcats" => $subcatlist);			if ($parent != 0)				$this->output .= $module->html_skincall("sub_cat_foot", $this->html, $data);			else				$this->output .= $module->html_skincall("cat_foot", $this->html, $data);		}		return $catsShown;	}}