<?php/* * Copyright (c) 2023. * RW::Software * Dave Conley * https://www.rwscripts.com/ */$loader = new admin_logs();class admin_logs{	var $output = "";	function admin_logs()	{		global $IN, $OUTPUT;		switch ($IN["act"]) {			case 'leech':				$this->logs_leech();				break;			case 'downloads':				$this->logs_downloads();				break;			case 'admin':				$this->logs_admin();				break;			case 'error':				$this->logs_error();				break;			case 'empty':				$this->emptyLogFile();				break;			case 'save':				$this->saveLogToFile($IN['id']);				break;			case 'userdownloads':				$this->userDownloads();				break;		}		$OUTPUT->add_output($this->output);	}	function logs_leech()	{		global $DB, $IN, $CONFIG, $guser, $sid, $std;		$this->output .= admin_head(GETLANG("nav_logs"), GETLANG("nav_leechlogs"));		if (!$IN["limit"])			$limit = 0;		else			$limit = intval($IN["limit"]);		$this->output .= "[ <a href='admin.php?sid=$sid&area=logs&act=save&id=1'>Save this log file</a> ] [ <a href='admin.php?sid=$sid&area=logs&act=empty&id=1'>Empty this log file</a> ]<br>";		// Type 1 is leech logs		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='1'");		$rows = $DB->num_rows();		$users = $guser->getAllUsers("`{$guser->db_name}`", "", false);		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='1' ORDER BY `time` DESC LIMIT $limit , {$CONFIG[links_per_page]}");		$this->output .= $std->pages($rows, $CONFIG["links_per_page"], "admin.php?sid=$sid&area=logs&act=leech");		$this->output .= new_table();		$this->output .= new_row(-1, "acptablesubhead");		$this->output .= GETLANG("log_file");		$this->output .= new_col();		$this->output .= GETLANG("log_refer");		$this->output .= new_col();		$this->output .= GETLANG("log_time");		$this->output .= new_col();		$this->output .= GETLANG("log_ip");		$this->output .= new_col();		$this->output .= GETLANG("user");		if ($myrow = $DB->fetch_row()) {			do {				$this->output .= new_row(-1, "normalrow");				$this->output .= "<a href='index.php?dlid={$myrow['file']}'>{$myrow['filename']}</a>";				$this->output .= new_col();				$this->output .= $this->logs_formaturl($myrow['referer']);				$this->output .= new_col();				$this->output .= date("d/M/y G:i:s", $myrow['time']);				$this->output .= new_col();				$this->output .= "<a href='http://whois.sc/{$myrow['IP']}'>{$myrow['IP']}</a>";				$this->output .= new_col();				$this->output .= $users[$myrow['userid']]['username'];			} while ($myrow = $DB->fetch_row());		}		$this->output .= end_table();		$this->output .= admin_foot();	}	function logs_downloads()	{		global $DB, $IN, $CONFIG, $guser, $sid, $std;		$this->output .= admin_head(GETLANG("nav_logs"), GETLANG("nav_downloadlogs"));		if (!$IN["limit"])			$limit = 0;		else			$limit = intval($IN["limit"]);		$this->output .= "[ <a href='admin.php?sid=$sid&area=logs&act=save&id=2'>Save this log file</a> ] [ <a href='admin.php?sid=$sid&area=logs&act=empty&id=2'>Empty this log file</a> ]<br>";		// Type 1 is leech logs		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='2'");		$rows = $DB->num_rows();		$users = $guser->getAllUsers("`{$guser->db_name}`", "", false);		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='2' ORDER BY `time` DESC LIMIT $limit , {$CONFIG[links_per_page]}");		$this->output .= $std->pages($rows, $CONFIG["links_per_page"], "admin.php?sid=$sid&area=logs&act=downloads");		$this->output .= new_table();		$this->output .= new_row(-1, "acptablesubhead");		$this->output .= GETLANG("log_file");		$this->output .= new_col();		$this->output .= GETLANG("log_refer");		$this->output .= new_col();		$this->output .= GETLANG("log_time");		$this->output .= new_col();		$this->output .= GETLANG("log_ip");		$this->output .= new_col();		$this->output .= GETLANG("user");		if ($myrow = $DB->fetch_row()) {			do {				$this->output .= new_row(-1, "normalrow");				$this->output .= "<a href='index.php?dlid={$myrow['file']}'>{$myrow['filename']}</a>";				$this->output .= new_col();				$this->output .= $this->logs_formaturl($myrow['referer']);				$this->output .= new_col();				$this->output .= date("d/M/y G:i:s", $myrow['time']);				$this->output .= new_col();				$this->output .= "<a href='http://whois.sc/{$myrow['IP']}'>{$myrow['IP']}</a>";				$this->output .= new_col();				$this->output .= $users[$myrow['userid']][$guser->db_name];			} while ($myrow = $DB->fetch_row());		}		$this->output .= end_table();		$this->output .= admin_foot();	}	function logs_admin()	{		global $DB, $IN, $CONFIG, $guser, $sid, $std;		$this->output .= admin_head(GETLANG("nav_logs"), GETLANG("nav_adminlogs"));		if (!$IN["limit"])			$limit = 0;		else			$limit = intval($IN["limit"]);		$this->output .= "[ <a href='admin.php?sid=$sid&area=logs&act=save&id=3'>Save this log file</a> ] [ <a href='admin.php?sid=$sid&area=logs&act=empty&id=3'>Empty this log file</a> ]<br>";		// Type 1 is leech logs		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='3'");		$rows = $DB->num_rows();		$users = $guser->getAllUsers("`{$guser->db_name}`", "", false);		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='3' ORDER BY `time` DESC LIMIT $limit , {$CONFIG[links_per_page]}");		$this->output .= $std->pages($rows, $CONFIG["links_per_page"], "admin.php?sid=$sid&area=logs&act=admin");		$this->output .= new_table();		$this->output .= new_row(-1, "acptablesubhead");		$this->output .= GETLANG("user");		$this->output .= new_col();		$this->output .= GETLANG("action");		$this->output .= new_col();		$this->output .= GETLANG("log_time");		$this->output .= new_col();		$this->output .= GETLANG("log_ip");		if ($myrow = $DB->fetch_row()) {			do {				$this->output .= new_row(-1, "normalrow");				$this->output .= $users[$myrow['userid']][$guser->db_name];				$this->output .= new_col();				$this->output .= $myrow['referer'];				$this->output .= new_col();				$this->output .= date("d/M/y G:i:s", $myrow['time']);				$this->output .= new_col();				$this->output .= "<a href='http://whois.sc/{$myrow['IP']}'>{$myrow['IP']}</a>";				$this->output .= new_col();			} while ($myrow = $DB->fetch_row());		}		$this->output .= end_table();		$this->output .= admin_foot();	}	function logs_error()	{		global $DB, $IN, $CONFIG, $guser, $sid, $std;		$this->output .= admin_head(GETLANG("nav_logs"), GETLANG("nav_errorlogs"));		if (!$IN["limit"])			$limit = 0;		else			$limit = intval($IN["limit"]);		$this->output .= "[ <a href='admin.php?sid=$sid&area=logs&act=save&id=4'>Save this log file</a> ] [ <a href='admin.php?sid=$sid&area=logs&act=empty&id=4'>Empty this log file</a> ]<br>";		// Type 1 is leech logs		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='4'");		$rows = $DB->num_rows();		$users = $guser->getAllUsers("`{$guser->db_name}`", "", false);		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='4' ORDER BY `time` DESC LIMIT $limit , {$CONFIG[links_per_page]}");		$this->output .= $std->pages($rows, $CONFIG["links_per_page"], "admin.php?sid=$sid&area=logs&act=error");		$this->output .= new_table();		$this->output .= new_row(-1, "acptablesubhead");		$this->output .= GETLANG("user");		$this->output .= new_col();		$this->output .= GETLANG("error");		$this->output .= new_col();		$this->output .= GETLANG("url");		$this->output .= new_col();		$this->output .= GETLANG("log_time");		$this->output .= new_col();		$this->output .= GETLANG("log_ip");		if ($myrow = $DB->fetch_row()) {			do {				$this->output .= new_row(-1, "normalrow");				$this->output .= $users[$myrow['userid']][$guser->db_name];				$this->output .= new_col();				$this->output .= $myrow['referer'];				$this->output .= new_col();				$this->output .= $myrow['filename'];				$this->output .= new_col();				$this->output .= date("d/M/y G:i:s", $myrow['time']);				$this->output .= new_col();				$this->output .= "<a href='http://whois.sc/{$myrow['IP']}'>{$myrow['IP']}</a>";				$this->output .= new_col();			} while ($myrow = $DB->fetch_row());		}		$this->output .= end_table();		$this->output .= admin_foot();	}	function saveLogToFile($type = 1)	{		global $DB, $IN, $CONFIG, $guser, $sid, $std;		$output = "<html>                    <head>                    <meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1'>                    </head>                    <body>";		$output .= admin_head(GETLANG("nav_logs"), GETLANG("nav_downloadlogs"));		if (!$IN["limit"])			$limit = 0;		else			$limit = intval($IN["limit"]);		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='{$type}'");		$rows = $DB->num_rows();		$users = $guser->getAllUsers("`{$guser->db_name}`", "", false);		$DB->query("SELECT * FROM `dl_logs` WHERE `type`='{$type}' ORDER BY `time` DESC");		$output .= new_table();		$output .= new_row(-1, "acptablesubhead");		$output .= GETLANG("log_file");		$output .= new_col();		$output .= GETLANG("log_refer");		$output .= new_col();		$output .= GETLANG("log_time");		$output .= new_col();		$output .= GETLANG("log_ip");		$output .= new_col();		$output .= GETLANG("user");		if ($myrow = $DB->fetch_row()) {			do {				$output .= new_row();				$output .= "<a href='index.php?dlid={$myrow['file']}'>{$myrow['filename']}</a>";				$output .= new_col();				$output .= $this->logs_formaturl($myrow['referer']);				$output .= new_col();				$output .= date("d/M/y G:i:s", $myrow['time']);				$output .= new_col();				$output .= "<a href='http://whois.sc/{$myrow['IP']}'>{$myrow['IP']}</a>";				$output .= new_col();				$output .= $users[$myrow['userid']][$guser->db_name];			} while ($myrow = $DB->fetch_row());		}		$output .= end_table();		$output .= admin_foot();		$output .= "</body></html>";		$fileName = $CONFIG['sitepath'] . "/archive_out/logs_{$type}.htm";		$url = $CONFIG['siteurl'] . "/archive_out/logs_{$type}.htm";		if ($fp = fopen($fileName, 'w')) {			fwrite($fp, $output, strlen($output));			fclose($fp);			$std->info("Log file saved to <a href='{$url}'>{$url}</a>");			return true;		} else {			$std->error("Could not create/save log file to {$fileName}. Please ensure directory is set with write permissions [777/666]");			return false;		}	}	function emptyLogFile()	{		global $IN, $std, $DB, $sid, $OUTPUT;		if ($IN["confirm"]) {			$this->saveLogToFile($IN['id']);			$OUTPUT->add_output(admin_head(GETLANG("nav_logs"), GETLANG("nav_downloadlogs")));			$DB->query("DELETE FROM `dl_logs` WHERE type={$IN['id']}");			$OUTPUT->add_output(GETLANG("logsemptied") . "<br><br>");			switch ($IN['id']) {				case 1:					$act = "leech";					$area = GETLANG("nav_leechlogs");					break;				case 2:					$act = "downloads";					$area = GETLANG("nav_downloadlogs");					break;				case 3:					$act = "admin";					$area = GETLANG("nav_adminlogs");					break;				case 4:					$act = "error";					$area = GETLANG("nav_errorlogs");					break;			}			$OUTPUT->add_output("+ <a href='admin.php?sid=$sid&area=logs&act={$act}'>" . GETLANG("backto") . " {$area}</a><br>");			$OUTPUT->add_output(admin_foot());			$std->addAdminLog("Emptied log file {$IN['id']}. Backed up to archive_out");			return;		} else if ($IN["cancel"]) {			$OUTPUT->add_output(GETLANG("emptylogcancel") . "<br><br>");			$OUTPUT->add_output("+ <a href='admin.php?sid=$sid&area=logs&act=leech'>" . GETLANG("backto") . " " . GETLANG("nav_leechlogs") . "</a><br>");			return;		} else {			$std->warning(GETLANG("warn_emptylogs") . "<p>"				. "<form method='post' action='admin.php?sid=$sid&area=logs&act=empty&id={$IN['id']}'>"				. "<input type='Submit' name='confirm' value='" . GETLANG("yes") . "'> <input type='Submit' name='cancel' value='" . GETLANG("no") . "'> </form>");		}	}	function logs_formaturl($url)	{		$parseurl = parse_url($url);		$shorturl = $parseurl['host'];		return "<a href='$url'>$shorturl</a>";	}	function userdownloads()	{		global $DB, $IN, $CONFIG, $sid, $std;		$this->output .= admin_head(GETLANG("nav_logs"), GETLANG("nav_dlreport"));		if (!$IN["limit"])			$limit = 0;		else			$limit = $IN["limit"];		if ($IN['id']) {			$DB->query("SELECT * FROM `dl_logs` WHERE `type`='2' AND `userid`='{$IN['id']}'");			$rows = $DB->num_rows();			$DB->query("SELECT * FROM `dl_logs` WHERE `type`='2' AND `userid`='{$IN['id']}' ORDER BY `time` DESC LIMIT $limit , {$CONFIG[links_per_page]}");			$this->output .= $std->pages($rows, $CONFIG["links_per_page"], "admin.php?sid=$sid&area=logs&act=userdownloads");			$this->output .= new_table();			$this->output .= new_row(-1, "acptablesubhead");			$this->output .= "File name";			$this->output .= new_col();			$this->output .= "Time";			$this->output .= new_col();			$this->output .= "IP";			if ($myrow = $DB->fetch_row()) {				do {					$this->output .= new_row();					$this->output .= "<a href='index.php?dlid={$myrow['file']}'>{$myrow['filename']}</a>";					$this->output .= new_col();					$this->output .= $std->formatDate($myrow['time']);					$this->output .= new_col();					$this->output .= "<a href='http://whois.sc/{$myrow['IP']}'>{$myrow['IP']}</a>";				} while ($myrow = $DB->fetch_row());			}			$this->output .= end_table();		} else {			$DB->query("SELECT * FROM `dl_users` ");			$rows = $DB->num_rows();			$DB->query("SELECT * FROM `dl_users` , `dl_memberextra` WHERE id=mid ORDER BY `downloaded` DESC LIMIT $limit , {$CONFIG[links_per_page]}");			$this->output .= $std->pages($rows, $CONFIG["links_per_page"], "admin.php?sid=$sid&area=logs&act=userdownloads");			$this->output .= new_table();			$this->output .= new_row(-1, "acptablesubhead");			$this->output .= "UserName";			$this->output .= new_col();			$this->output .= "Downloaded";			if ($myrow = $DB->fetch_row()) {				do {					$this->output .= new_row();					$this->output .= "<a href='admin.php?sid=$sid&amp;area=logs&amp;act=userdownloads&amp;id={$myrow['id']}'>{$myrow['username']}</a>";					$this->output .= new_col();					$this->output .= "{$myrow['downloaded']}";				} while ($myrow = $DB->fetch_row());			}			$this->output .= end_table();		}		$this->output .= admin_foot();	}}?>