<?php/* * Copyright (c) 2023. * RW::Software * Dave Conley * https://www.rwscripts.com/ *//********************************************************* * $HeadURL: http://www.maidenfans.com/svn/rwdownload_new/TRUNK/functions/admin/ad_main.php $ * $Revision: 14 $ * $LastChangedBy: realworld $ * $LastChangedDate: 2008-03-09 20:55:49 +0000 (Sun, 09 Mar 2008) $ *********************************************************/class admin_upgrade{	var $output;	function admin_upgrade()	{		global $std, $IN, $OUTPUT;		switch ($IN['act']) {			default:				if ($this->upgrade_main()) {					$std->info("Upgrade complete. Please run test again to check for further updates. There may be more than one.");				} else {					$std->info("You are already fully up to date.");				}				break;		}		$OUTPUT->add_output($this->output);	}	function minimum_version($vercheck)	{		$minver = explode(".", $vercheck);		$curver = explode(".", phpversion());		if (($curver[0] < $minver[0]) ||			(($curver[0] == $minver[0]) and ($curver[1] < $minver[1])) ||			(($curver[0] == $minver[0]) and ($curver[1] == $minver[1]) and				($curver[2][0] < $minver[2][0])))			return false;		else			return true;	}	function upgrade_main()	{		global $CONFIG, $buildnum, $std, $sid;		require_once(ROOT_PATH . "/engine/communicate.php");		$comm = new communicate();		$isPHP5 = ($this->minimum_version("5.0")) ? 1 : 0;		$data = $comm->getRemoteFile("http://www.rwscripts.com/sources/getupdates.php?buildnum=$buildnum&php5=$isPHP5");		if ($data) {			$zipfile = fopen(ROOT_PATH . "/temp/update.tar.gz", "w");			fwrite($zipfile, $data);			fclose($zipfile);		} else			return false;		require_once(ROOT_PATH . "/engine/tar.php");		$gzip = new gzip_file("./update.tar.gz");		$gzip->set_options(array("overwrite" => 1, "basedir" => ROOT_PATH . "/temp/"));		$gzip->extract_files("admin.php?sid={$sid}&area=upgrade&act=home");		if (!empty($gzip->error)) {			foreach ($gzip->error as $err) {				echo "{$err}<br>";			}		} else {			$this->moveFilesFromDir("");			unlink(ROOT_PATH . "/temp/update.tar.gz");			return true;		}	}	function moveFilesFromDir($dir)	{		global $std;		$dir_handle = @opendir(ROOT_PATH . "/temp/" . $dir) or exit("No " . ROOT_PATH . "/temp/{$dir} directory!");		if ($file = readdir($dir_handle)) {			do {				if (is_dir(ROOT_PATH . "/temp/{$dir}/{$file}") and $file != "." and $file != ".." and $file != ".svn") {					$this->moveFilesFromDir($dir . "/{$file}");				} else if (!is_dir(ROOT_PATH . "/temp/{$dir}/{$file}") && $file != "." and $file != ".." and $file != "index.htm" and $file != "update.tar.gz") {					if ((is_file(ROOT_PATH . "/{$dir}/{$file}") && unlink(ROOT_PATH . "/{$dir}/{$file}")) || !is_file(ROOT_PATH . "/{$dir}/{$file}")) {						if (!rename(ROOT_PATH . "/temp/{$dir}/{$file}", ROOT_PATH . "/{$dir}/{$file}")) {							$std->error("Could not move " . ROOT_PATH . "/temp/{$dir}/{$file} to " . ROOT_PATH . "/{$dir}/{$file}");						}					} else {						$std->error("Could not modify " . ROOT_PATH . "/{$dir}/{$file}. The permissions may be incorrectly set.");					}				}			} while ($file = readdir($dir_handle));		}		if ($dir) {			rmdir(ROOT_PATH . "/temp/{$dir}/");		}	}	function admin_news()	{		$this->output .= admin_head(GETLANG("rwdownload"), GETLANG("news"));		ob_start();		readfile("http://www.rwscripts.com/index.php?ACT=module&name=rwnews");		$this->output .= ob_get_contents();		ob_end_clean();		$this->output .= admin_foot();	}}$loader = new admin_upgrade();?>